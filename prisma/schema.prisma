generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ATHLETE
  COACH
  ADMIN
}

enum Units {
  MILES
  KM
}

enum ActivityType {
  RUN
  STRENGTH
  CROSS_TRAIN
  REST
  MOBILITY
  YOGA
  HIKE
  OTHER
}

enum ActivityPriority {
  KEY
  MEDIUM
  OPTIONAL
}

model User {
  id           String   @id
  email        String   @unique
  name         String
  role         UserRole @default(ATHLETE)
  currentRole  UserRole @default(ATHLETE)
  hasBothRoles Boolean  @default(false)
  isActive     Boolean  @default(true)
  deactivatedAt DateTime?
  units        Units?   @default(MILES)
  paceTargets  Json?
  goalRaceDate DateTime?
  createdAt    DateTime @default(now())

  athleteLinks CoachAthlete[] @relation("Athlete")
  coachLinks   CoachAthlete[] @relation("Coach")
  ownedPlans   TrainingPlan[] @relation("PlanOwner")
  athletePlans TrainingPlan[] @relation("AthletePlan")
  externalAccounts ExternalAccount[]
  externalActivities ExternalActivity[]
}

model CoachAthlete {
  id         String   @id @default(cuid())
  coachId    String
  athleteId  String
  createdAt  DateTime @default(now())

  coach   User @relation("Coach", fields: [coachId], references: [id])
  athlete User @relation("Athlete", fields: [athleteId], references: [id])

  @@unique([coachId, athleteId])
}

enum PlanStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum RaceType {
  MARATHON
  HALF_MARATHON
  TEN_K
  FIVE_K
  ULTRA_50K
  ULTRA_50MI
  ULTRA_100K
  ULTRA_100MI
  TRAIL
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum IntegrationProvider {
  STRAVA
  GARMIN
}

model TrainingPlan {
  id          String      @id @default(cuid())
  name        String
  raceName    String?
  description String?
  isTemplate  Boolean     @default(false)
  status      PlanStatus  @default(DRAFT)
  weekCount   Int?
  raceDate    DateTime?
  raceType    RaceType?
  difficulty  Difficulty?
  isPublic    Boolean     @default(false)
  sourceId    String?
  parseProfile Json?
  createdAt   DateTime    @default(now())

  ownerId    String?
  athleteId  String?

  owner      User? @relation("PlanOwner", fields: [ownerId], references: [id])
  athlete    User? @relation("AthletePlan", fields: [athleteId], references: [id])

  weeks      PlanWeek[]
  days       PlanDay[]
  activities PlanActivity[]
}

model PlanWeek {
  id        String   @id @default(cuid())
  planId    String
  weekIndex Int
  startDate DateTime?
  endDate   DateTime?

  plan TrainingPlan @relation(fields: [planId], references: [id])
  days PlanDay[]

  @@unique([planId, weekIndex])
}

model PlanDay {
  id        String   @id @default(cuid())
  planId    String
  weekId    String
  dayOfWeek Int
  rawText   String?
  notes     String?

  plan TrainingPlan @relation(fields: [planId], references: [id])
  week PlanWeek @relation(fields: [weekId], references: [id])
  activities PlanActivity[]

  @@unique([weekId, dayOfWeek])
}

model PlanActivity {
  id        String   @id @default(cuid())
  planId    String
  dayId     String
  type      ActivityType @default(OTHER)
  subtype   String?
  title     String
  rawText   String?
  distance  Float?
  distanceUnit Units?
  duration  Int?
  paceTarget String?
  effortTarget String?
  structure Json?
  tags      Json?
  priority  ActivityPriority?
  bailAllowed Boolean @default(false)
  mustDo    Boolean @default(false)
  completed Boolean  @default(false)
  completedAt DateTime?
  actualDistance Float?
  actualDuration Int?
  actualPace String?
  notes     String?

  plan TrainingPlan @relation(fields: [planId], references: [id])
  day  PlanDay @relation(fields: [dayId], references: [id])
  externalActivities ExternalActivity[] @relation("MatchedPlanActivity")
}

model ExternalAccount {
  id               String              @id @default(cuid())
  userId           String
  provider         IntegrationProvider
  providerUserId   String?
  providerUsername String?
  tokenType        String?
  accessToken      String?
  refreshToken     String?
  scopes           String?
  expiresAt        DateTime?
  syncCursor       String?
  connectedAt      DateTime            @default(now())
  lastSyncAt       DateTime?
  isActive         Boolean             @default(true)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  user       User               @relation(fields: [userId], references: [id])
  activities ExternalActivity[]

  @@unique([userId, provider])
  @@unique([provider, providerUserId])
  @@index([userId, provider])
}

model ExternalActivity {
  id                    String              @id @default(cuid())
  accountId             String
  userId                String
  provider              IntegrationProvider
  providerActivityId    String
  name                  String?
  sportType             String?
  startTime             DateTime
  durationSec           Int?
  movingTimeSec         Int?
  elapsedTimeSec        Int?
  distanceM             Float?
  avgHeartRate          Int?
  maxHeartRate          Int?
  calories              Float?
  avgPaceSecPerKm       Float?
  raw                   Json?
  matchedPlanActivityId String?
  importedAt            DateTime            @default(now())
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  account             ExternalAccount @relation(fields: [accountId], references: [id])
  user                User            @relation(fields: [userId], references: [id])
  matchedPlanActivity PlanActivity?   @relation("MatchedPlanActivity", fields: [matchedPlanActivityId], references: [id])

  @@unique([provider, providerActivityId])
  @@index([userId, startTime])
  @@index([accountId, startTime])
  @@index([matchedPlanActivityId])
}
